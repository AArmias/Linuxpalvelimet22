# h7 - DJ Prod

Alla kurssin viimeinen palautus. Tehtävä tehty 11.10.2022 omalla henkilökohtaisella koneellani.

Pääkone:

- Windows 10 Pro 
- 32GB RAM 
- 2TB levytilaa 

Virtuaalikoneen kokoonpano:

- Oracle VirtualBox 6.1.36 
- Ubuntu 22.04.1 
- Apache 2
- Django 
- 8192MB RAM 
- 25GB levytilaa

Lisäksi: 

- Pilvipalvelin vuokrattu DigitalOceanista. 
- Nimipalvelu hankittu Name.comista 
- Käytetty apuna Github Educationin etuja ja alennuksia. 

-------------------------------------------------------------------

### x) Kaikki tehtävät arvioitavaksi. Palauta linkit kaikkiin kotitehtäväraportteihisi. Arviointi tehdään ensisijaisesti tästä linkistä. (tässä alakohdassa ei tarvitse tehdä testejä koneella)

**Alla linkki kaikkiin palautuksiini.** 

- h1  - https://github.com/AArmias/Linuxpalvelimet22/blob/main/h1.md
- h2  - https://github.com/AArmias/Linuxpalvelimet22/blob/main/h2.md
- h3  - https://github.com/AArmias/Linuxpalvelimet22/blob/main/h3.md
- h4  - https://github.com/AArmias/Linuxpalvelimet22/blob/main/h4.md
- h5  - https://github.com/AArmias/Linuxpalvelimet22/blob/main/h5.md
- h6  - https://github.com/AArmias/Linuxpalvelimet22/blob/main/h6.md

------------------------------------------------------------------------------------

### a) Asenna PostgreSQL, tee sille tietokantakäyttäjä ja tietokanta, osoita että se toimii (esim "SELECT 1+1;")

Kuten useammassa tehtävässä tässäkin homma alkaa pakettilistan päivittämisellä, jotta saatavilla on viimeisimmät versiot. 
`sudo apt-get update` auttaa meitä tässä. 

Seuraavaksi asennetaan PostgreSQL komennolla `sudo apt-get -y install postgresql` ja yhteensopivuuden varmistamiseksi vielä tunnilla opittu `sudo apt-get install python3-psycopg2`

Luodaan database: `sudo -u postgres createdb teros` ja luodaan käyttäjä: `sudo -u postgres createuser teros`

Nyt meillä on asennettuna PostgreSQL, asennettu python3:n psycopg2 laajennus ja luotu teros niminen database ja teros niminen käyttäjä. 
Ollaan valmiita testaamaan toimivuutta.

Komennolla `psql` käynnistetään PostgreSQL.
Testataan syötteillä: `SELECT 1+1;`, `SELECT 2+1;` ja `SELECT 2+4;` toimiiko asennus. 

![image](https://user-images.githubusercontent.com/102689055/195047028-14a2789c-a7ba-4306-8efc-b56587ff36b1.png)

Asennus toimii! 

----------------------------------------------

### b) Ota Djanogsta yhteys Postgre-tietokantaasi.

Ennen tätä tehtävää on palautuksessa h6 (https://github.com/AArmias/Linuxpalvelimet22/blob/main/h6.md) asennettu tuotanto versio Djangosta ja 
palautuksessa h5 (https://github.com/AArmias/Linuxpalvelimet22/blob/main/h5.md) Django testiympäristössä. Tätä tehtävää aloittaessa, meillä on siis toimiva django asennus ja sitä hallitsemassa superuser teros. HUOM! h6 tehtävässä otettiin debug tila pois käytöstä. Ennen tämän tehtävän aloitusta laitoin debug tilan takaisin **päälle**. Mikäli ilmenee ongelmia on debug tila päällä helpompi selvittää, mikä on ongelmana. 

Jotta edellisessä tehtävässä asennettu postgeSQL saadaan käyttöön Djangossa, tulee meidän muuttaa djangon asetuksia.
Tiedetään myös, että meidän settings.py tiedosto projektille löytyy hakemistosta **publicwsgi/teron/teron/teron/**. Joten mennään tuohon hakemistoon `cd publicwsgi/teron/teron/teron/`
ja avataan kyseinen tiedosto: `micro settings.py`. 

Etsitään rivi joka koskee databasea eli DATABASES ja muutetaan sitä hieman: 

`DATABASES = {
      'default': {
        'ENGINE': 'django.db.backends.postgresql',
        'USER': 'teros',
        'NAME': 'teros',
      }
 }
 ` 


Kuvasta näkyy hyvin, miten ylläoleva DATABASES on korvattu alempana olevalla versiolla. 
Mikäli ongelmia olisi syntyy, voin poistaa alemman version ja ottaa ylemmän takaisin käyttööni poistamalla risuaidat. 
Näin saan helpotettua ongelman ratkaisua ja vian löytymistä. 

![image](https://user-images.githubusercontent.com/102689055/195051368-3bb93fe8-8506-48b1-9075-287a20492f08.png)

Kokeillaan: 
`touch teron/wsgi.py` ja `sudo systemctl restart apache2` (apachen uudelleen käynnistys)
`./manage.py runserver` (serveri käyntiin)
![image](https://user-images.githubusercontent.com/102689055/195059386-6d2f1363-4349-4f7c-9623-2b9c22705932.png)



HUPS! Ongelmia edessä! 
Koska meillä on debug tila päällä, meille selviää heti mikä on ongelmana. 
Meidän tulee siis lisätä '127.0.0.1' ALLOWED_HOSTS kohtaan settings.py tiedostossa. 
![image](https://user-images.githubusercontent.com/102689055/195057988-3e0b8282-3c31-48c1-9660-fe0f6962ba4c.png)

Ensiksi `micro settings.py` ja lisättiin '127.0.0.1' localhostin lisäksi tuonne ALLOWED_HOSTS kohtaan ja tallennetaan.  
`touch teron/wsgi.py` ja `sudo systemctl restart apache2` ja serverit käyntiin `./manage.py runserver`

![image](https://user-images.githubusercontent.com/102689055/195057768-cdcc175f-3073-470c-94a0-6455e5d7086e.png)

Nyt yhteys toimii! 


![image](https://user-images.githubusercontent.com/102689055/195057687-8037f06d-bc40-4fc5-8fb5-d489d41a9191.png)


-------------------------------------------------------------------------

### e) Ratkaise valitsemasi vanha arvioitava laboratorioharjoitus tältä kurssilta. (Löytyy DuckDuckGolla, Googlella, linkeistä tältä sivulta tai hakemalla yläreunan hakutoiminnolla). Sovella tarvittaessa tehtäviä tähän toteutukseen sopivaksi, esimerkiksi PHP:n tilalta voi tehdä vastaavan Pythonilla; Flaskin tilalta käyttää Djangoa. Tai jättää pois jonkin epärelevantin kohdan.


-------------------------------------------------------------------------

### f) Tee uusi tyhjä virtuaalikone (tai oikea kone) viimeisen kerran arvioitavaa labraa varten. Koneella ei saa olla luottamuksellisia tietoja. Kannattaa tehdä koneelle tarpeeksi iso virtuaalinen levy ja laittaa riittävästi RAM:ia. Guest additions saa olla asennettuna. Koneella ei saa olla muita asetuksia ennakkoon, eikä ylimääräisiä asennettuja ohjelmia.

Valmistelin koetta varten sekä Ubuntun, että myös Debianin.

Molemmissa sennuksissa: 
- 8192MB RAM 
- ~25GB vapaata levytilaa

![image](https://user-images.githubusercontent.com/102689055/195054166-0d08c96f-afaf-4a5c-a43e-d83d6750fffd.png)


-------------------------------------------------------------------

#### Lähteet:

- Linux Palvelimet 2022 - https://terokarvinen.com/2022/linux-palvelimet-ict4tn021-3020/
- Tero Karvinen: PostgreSQL Install and One Table Database – SQL CRUD tutorial for Ubuntu - https://terokarvinen.com/2016/postgresql-install-and-one-table-database-sql-crud-tutorial-for-ubuntu/
- Tero Karvinen: Install PostgreSQL on Ubuntu – New user and database in 3 commands - https://terokarvinen.com/2016/install-postgresql-on-ubuntu-new-user-and-database-in-3-commands/?fromSearch=post

